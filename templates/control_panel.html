<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel - Impostor Game</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 16px;
        }
        .card {
            background: rgba(255,255,255,0.97);
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.10);
            padding: 28px 24px 20px 24px;
            margin-bottom: 0;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 1.25em;
            font-weight: bold;
            margin-bottom: 16px;
            color: #333;
        }
        .console-output {
            background: #181c20;
            color: #b6e1ff;
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 0.98em;
            border-radius: 10px;
            padding: 18px 12px;
            min-height: 180px;
            max-height: 260px;
            overflow-y: auto;
            margin-bottom: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stats-list {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
        }
        .stats-list li {
            margin-bottom: 7px;
            color: #444;
        }
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .player-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px 18px 10px 16px;
            position: relative;
            font-weight: 500;
            color: #333;
            min-width: 90px;
            margin-bottom: 0;
            transition: box-shadow 0.2s, background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            cursor: pointer;
        }
        .player-card:hover {
            background: #ffeaea;
            box-shadow: 0 4px 16px rgba(231,76,60,0.13);
        }
        .kick-cross {
            display: none;
            position: absolute;
            top: 6px;
            right: 10px;
            color: #e74c3c;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
        }
        .player-card:hover .kick-cross {
            display: block;
        }
        .spicy-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .spicy-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            background: #eee;
            color: #555;
            transition: background 0.2s, color 0.2s;
        }
        .spicy-btn.active {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #222;
        }
        .spicy-btn.forced.active {
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            color: #fff;
        }
        .spicy-btn.disabled.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
        }
        .settings-list label {
            font-weight: 500;
            margin-right: 10px;
        }
        .settings-list input {
            width: 60px;
            padding: 4px 6px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 16px;
        }
        .settings-save-btn {
            margin-top: 10px;
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }
        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            transition: background 0.2s;
        }
        .action-btn.reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .action-btn.leaderboard {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .action-btn.copy {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        .action-btn:active {
            filter: brightness(0.95);
        }
        .leaderboard-reset-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .spicy-announcement {
            margin-top: 12px;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.08em;
            display: inline-block;
        }
        .spicy-announcement.forced {
            background: #ffeaea;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        .spicy-announcement.possible {
            background: #fff6e0;
            color: #e67e22;
            border: 2px solid #e67e22;
        }
        .spicy-toggle-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .spicy-toggle-label {
            font-size: 0.98em;
            font-weight: 500;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .spicy-toggle-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid #bbb;
            background: #fff;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s, background 0.2s;
        }
        .spicy-toggle-checkbox:checked,
        .spicy-toggle-checkbox:checked:hover,
        .spicy-toggle-checkbox:checked:focus,
        .spicy-toggle-checkbox:checked:active {
            background: #7c4dff;
            border-color: #7c4dff;
        }
        .spicy-toggle-checkbox:not(:checked):hover,
        .spicy-toggle-checkbox:not(:checked):focus,
        .spicy-toggle-checkbox:not(:checked):active {
            background: #f3f3fa;
            border-color: #bbb;
        }
        .spicy-toggle-checkbox:checked::after,
        .dark-mode .spicy-toggle-checkbox:checked::after {
            content: none;
        }
        .spicy-toggle-checkbox:focus {
            box-shadow: 0 0 0 2px #7c4dff44;
        }
        .dark-mode .spicy-toggle-checkbox {
            background: #23272f;
            border: 2px solid #555;
        }
        .dark-mode .spicy-toggle-checkbox:checked,
        .dark-mode .spicy-toggle-checkbox:checked:hover,
        .dark-mode .spicy-toggle-checkbox:checked:focus,
        .dark-mode .spicy-toggle-checkbox:checked:active {
            background: #7c4dff;
            border-color: #7c4dff;
        }
        .dark-mode .spicy-toggle-checkbox:not(:checked):hover,
        .dark-mode .spicy-toggle-checkbox:not(:checked):focus,
        .dark-mode .spicy-toggle-checkbox:not(:checked):active {
            background: #23272f;
            border-color: #555;
        }
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        .live-stats-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 18px;
            cursor: pointer;
        }
        .live-stats-overlay-content {
            text-align: center;
            font-size: 1.25em;
            color: #e74c3c;
            font-weight: bold;
            background: rgba(255,255,255,0.95);
            padding: 24px 32px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .blurred {
            filter: blur(10px) grayscale(0.2);
            /* pointer-events: none; */
            /* user-select: none; */
        }
        .leaderboard-status-row {
            display: flex;
            gap: 18px;
            margin-bottom: 10px;
            font-size: 1em;
            align-items: center;
        }
        .file-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 1.05em;
        }
        .file-status .filename {
            font-size: 0.98em;
            color: #333;
            margin-left: 8px;
            font-weight: 400;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 2px 8px;
        }
        .file-status.present {
            color: #27ae60;
        }
        .file-status.missing {
            color: #e74c3c;
        }
        .file-status .status-icon {
            font-size: 1.2em;
        }
        .leaderboard-backup-row {
            display: flex;
            gap: 14px;
            margin-bottom: 12px;
        }
        .leaderboard-upload-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .leaderboard-upload-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .action-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .leaderboard-backup-card {
            grid-column: span 2;
        }
        @media (max-width: 900px) {
            .leaderboard-backup-card {
                grid-column: span 1;
            }
        }
        .custom-file-input {
            display: none;
        }
        .custom-file-label {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            padding: 7px 16px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            display: inline-block;
        }
        .custom-file-label:hover {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        }
        .selected-filename {
            font-size: 0.98em;
            color: #333;
            margin-left: 6px;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .action-btn.leaderboard {
            font-size: 1em;
            padding: 8px 0;
            min-width: 0;
            width: 100%;
            margin-bottom: 0;
        }
        .backup-list {
            margin: 10px 0 18px 0;
            padding: 0;
            list-style: none;
        }
        .backup-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 7px;
            padding: 6px 10px;
        }
        .backup-filename {
            font-size: 0.98em;
            color: #333;
            font-family: monospace;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .backup-action-btn {
            font-size: 0.95em;
            padding: 4px 10px;
            border-radius: 6px;
            border: none;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .backup-action-btn.restore {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        .backup-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .collapsible-section {
            display: none;
            margin-bottom: 12px;
        }
        .collapsible-section.open {
            display: block;
        }
        .collapsible-toggle-btn {
            width: 100%;
            margin-bottom: 10px;
            font-size: 1.05em;
            font-weight: bold;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .collapsible-toggle-btn:active {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        }
        .leaderboard-download-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .leaderboard-download-label {
            font-size: 0.98em;
            color: #333;
            font-weight: 500;
        }
        /* --- DARK MODE THEME --- */
        body.dark-mode {
            background: linear-gradient(135deg, #23242b 0%, #181a20 100%) !important;
            color: #fff !important;
        }
        .dark-mode .card {
            background: #23242b !important;
            color: #fff !important;
            border: 1.5px solid #38405a;
            box-shadow: 0 2px 16px 0 rgba(124,77,255,0.10);
        }
        .dark-mode .card-title {
            color: #7c4dff !important;
        }
        .dark-mode .console-output {
            background: #181c20 !important;
            color: #b6e1ff !important;
            border: 1.5px solid #38405a;
        }
        .dark-mode .stats-list li {
            color: #b0b3c0 !important;
        }
        .dark-mode .player-card {
            background: #23272f !important;
            color: #fff !important;
            border: 1.5px solid #388bff;
            box-shadow: 0 1px 4px 0 rgba(56,139,255,0.10);
        }
        .dark-mode .player-card:hover {
            background: #2a2d3a !important;
            box-shadow: 0 4px 16px #7c4dff33;
        }
        .dark-mode .kick-cross {
            color: #ff5252 !important;
        }
        .dark-mode .spicy-btn {
            background: #23272f !important;
            color: #b0b3c0 !important;
            border: 1.5px solid #38405a;
        }
        .dark-mode .spicy-btn.active {
            background: linear-gradient(135deg, #7c4dff 0%, #2979ff 100%) !important;
            color: #fff !important;
        }
        .dark-mode .spicy-btn.forced.active {
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%) !important;
            color: #fff !important;
        }
        .dark-mode .spicy-btn.disabled.active {
            background: linear-gradient(135deg, #27ae60 0%, #176d3b 100%) !important;
            color: #fff !important;
        }
        .dark-mode .settings-save-btn {
            background: linear-gradient(90deg, #2979ff 0%, #7c4dff 100%) !important;
            color: #fff !important;
        }
        .dark-mode .action-btn {
            background: linear-gradient(90deg, #2979ff 0%, #7c4dff 100%) !important;
            color: #fff !important;
        }
        .dark-mode .action-btn.reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        }
        .dark-mode .action-btn.leaderboard {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
        }
        .dark-mode .action-btn.copy {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
        }
        .dark-mode .leaderboard-status-row {
            color: #b0b3c0 !important;
        }
        .dark-mode .file-status {
            color: #b0b3c0 !important;
        }
        .dark-mode .file-status.present {
            color: #27ae60 !important;
        }
        .dark-mode .file-status.missing {
            color: #e74c3c !important;
        }
        .dark-mode .file-status .filename {
            background: #23272f !important;
            color: #7c4dff !important;
        }
        .dark-mode .backup-list-item {
            background: #23272f !important;
            color: #fff !important;
        }
        .dark-mode .backup-filename {
            color: #7c4dff !important;
        }
        .dark-mode .backup-action-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
            color: #fff !important;
        }
        .dark-mode .backup-action-btn.restore {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
        }
        .dark-mode .custom-file-label {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
            color: #fff !important;
        }
        .dark-mode .selected-filename {
            color: #b0b3c0 !important;
            background: #23272f !important;
        }
        .dark-mode .collapsible-toggle-btn {
            background: linear-gradient(135deg, #7c4dff 0%, #2979ff 100%) !important;
            color: #fff !important;
        }
        .dark-mode .spicy-announcement.forced {
            background: #2a2d3a !important;
            color: #e74c3c !important;
            border: 2px solid #e74c3c !important;
        }
        .dark-mode .spicy-announcement.possible {
            background: #2a2d3a !important;
            color: #e67e22 !important;
            border: 2px solid #e67e22 !important;
        }
        .dark-mode .spicy-announcement {
            background: #23272f !important;
            color: #7c4dff !important;
        }
        /* Unified dark mode toggle button style */
        .dark-mode-toggle {
            position: fixed;
            top: 18px;
            right: 28px;
            z-index: 1000;
            background: rgba(35,36,43,0.95);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35em;
            color: #7c4dff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10), 0 4px 24px #0002;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            backdrop-filter: blur(4px);
            padding: 0;
            line-height: 1;
            aspect-ratio: 1 / 1;
        }
        .dark-mode .dark-mode-toggle {
            background: rgba(35,36,43,0.95);
            color: #7c4dff;
            box-shadow: 0 0 12px #7c4dff, 0 2px 8px rgba(0,0,0,0.10);
        }
        .dark-mode-toggle:hover {
            box-shadow: 0 0 18px #7c4dff, 0 2px 8px rgba(0,0,0,0.10);
        }
        .dark-mode input[type="number"],
        .dark-mode input[type="text"],
        .dark-mode input[type="password"] {
            background: #23272f !important;
            color: #fff !important;
            border: 1.5px solid #38405a !important;
            border-radius: 6px;
        }
        .dark-mode input[type="number"]::placeholder,
        .dark-mode input[type="text"]::placeholder,
        .dark-mode input[type="password"]::placeholder {
            color: #b0b3c0 !important;
            opacity: 1;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" id="dark-mode-toggle" title="Dark Mode umschalten">🌙</button>
    <h1 style="color:#333;margin-top:32px;margin-bottom:0;font-size:2.1em;">🎛️ Control Panel</h1>
    <button onclick="window.location.href='/';" class="action-btn" style="margin-bottom:18px;min-width:unset;padding:8px 18px;font-size:15px;float:right;">🏠 Zurück zur Lobby</button>
    <div class="dashboard">
        <!-- Console Output Card -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-title">🖥️ Deployment Console Output</div>
            <div class="console-output" id="console-output">Lade...</div>
        </div>
        <!-- Live Stats Card -->
        <div class="card" id="live-stats-card" style="position:relative;">
            <div class="card-title">📊 Live Stats</div>
            <ul class="stats-list" id="stats-list"></ul>
            <button class="action-btn copy" id="copy-link-btn">🔗 Game-Link kopieren</button>
            <div id="live-stats-overlay" class="live-stats-overlay" style="display:none;">
                <div class="live-stats-overlay-content">
                    <span>🚫 Spoiler!<br>Klicken zum Anzeigen</span>
                </div>
            </div>
        </div>
        <!-- Player List Card -->
        <div class="card">
            <div class="card-title">👥 Spieler</div>
            <div class="player-list" id="player-list"></div>
        </div>
        <!-- Game Controls Card -->
        <div class="card">
            <div class="card-title">🎮 Game Controls</div>
            <button class="action-btn" id="start-game-btn">🎬 Spiel starten</button>
            <button class="action-btn reset" id="reset-game-btn">🔄 Spiel zurücksetzen</button>
            <div class="leaderboard-reset-group">
                <button class="action-btn leaderboard" onclick="resetLeaderboard('players')">Player LB zurücksetzen</button>
                <button class="action-btn leaderboard" onclick="resetLeaderboard('impostors')">Impostor LB zurücksetzen</button>
                <button class="action-btn leaderboard" onclick="resetLeaderboard('both')">Beide LBs zurücksetzen</button>
            </div>
        </div>
        <!-- Spicy Mode Card -->
        <div class="card">
            <div class="card-title">🌶️ Spicy Mode</div>
            <div class="spicy-toggle">
                <button class="spicy-btn disabled" id="spicy-disabled">Deaktiviert</button>
                <button class="spicy-btn" id="spicy-possible">Möglich</button>
                <button class="spicy-btn forced" id="spicy-forced">Erzwingen</button>
            </div>
            <div class="spicy-toggle-row">
                <label for="announce-spicy-toggle" class="spicy-toggle-label">
                    <input type="checkbox" id="announce-spicy-toggle" class="spicy-toggle-checkbox">
                    Spicy-Status im Lobby-Chat anzeigen
                </label>
            </div>
            <div id="spicy-mode-status" style="margin-top:8px;font-weight:500;"></div>
        </div>
        <!-- Settings Card -->
        <div class="card">
            <div class="card-title">⚙️ Einstellungen</div>
            <form id="settings-form">
                <div class="settings-list">
                    <label for="heartbeat-timeout">Heartbeat Timeout (s):</label>
                    <input type="number" id="heartbeat-timeout" name="heartbeat-timeout" min="2" max="60">
                    <label for="cleanup-interval">Cleanup Interval (s):</label>
                    <input type="number" id="cleanup-interval" name="cleanup-interval" min="2" max="60">
                </div>
                <button type="submit" class="settings-save-btn">Speichern</button>
            </form>
            <div id="settings-status" style="margin-top:8px;font-size:0.98em;"></div>
            <hr style="margin:18px 0;">
            <div style="margin-bottom:10px;font-weight:500;">🔑 Admin-Passwort ändern</div>
            <form id="change-password-form" style="display:flex;gap:10px;align-items:center;">
                <input type="password" id="new-password" placeholder="Neues Passwort" minlength="4" style="flex:1;padding:8px 12px;border-radius:6px;border:1.5px solid #ccc;font-size:1em;">
                <button type="submit" class="settings-save-btn" style="padding:8px 18px;">Ändern</button>
            </form>
            <div id="password-status" style="margin-top:8px;font-size:0.98em;"></div>
        </div>
        <!-- Leaderboard Backup/Restore Card -->
        <div class="card leaderboard-backup-card">
            <div class="card-title">🏆 Leaderboard Backup & Restore</div>
            <div class="leaderboard-status-row" id="leaderboard-status-row">
                <span class="file-status" id="status-leaderboard-json"><span class='status-icon'>⏳</span> Leaderboard: ...</span>
                <span class="file-status" id="status-leaderboard-bckp"><span class='status-icon'>⏳</span> Backup: ...</span>
            </div>
            <button class="action-btn leaderboard" id="backup-leaderboard-btn" style="margin-bottom:10px;width:100%;">Backup Leaderboard</button>
            <button class="collapsible-toggle-btn" id="toggle-backup-list-btn">Backups & Downloads anzeigen</button>
            <div class="collapsible-section" id="collapsible-backup-list">
                <div class="leaderboard-download-row">
                    <span class="leaderboard-download-label">Leaderboard:</span>
                    <span class="filename">leaderboard.json</span>
                    <button class="backup-action-btn" id="download-leaderboard-btn">Download</button>
                </div>
                <ul class="backup-list" id="backup-list"></ul>
            </div>
            <div class="leaderboard-upload-row">
                <label for="upload-leaderboard-file" class="custom-file-label">Datei auswählen</label>
                <span class="selected-filename" id="selected-leaderboard-filename">Keine Datei gewählt</span>
                <button class="action-btn leaderboard" id="upload-leaderboard-btn" style="width:auto;min-width:unset;padding:7px 16px;">Als Leaderboard hochladen</button>
            </div>
            <form id="upload-leaderboard-form" style="display:none;">
                <input type="file" id="upload-leaderboard-file" class="custom-file-input" accept="application/json">
            </form>
            <div id="leaderboard-backup-status" style="margin-top:10px;font-size:0.98em;"></div>
        </div>
    </div>
    <script>
    // --- Console Output ---
    function updateConsole() {
        fetch('/api/console_output').then(r => r.json()).then(data => {
            document.getElementById('console-output').textContent = data.output || 'No output.';
        });
    }
    setInterval(updateConsole, 4000);
    updateConsole();

    // --- Live Stats ---
    let gameLink = window.location.origin + '/';
    let liveStatsRevealed = false;
    function updateStats() {
        fetch('/api/control_stats').then(r => r.json()).then(data => {
            let stats = [
                `<b>Status:</b> ${data.game_state}`,
                `<b>Spieler:</b> ${data.player_count}`,
                `<b>Impostor:</b> ${data.impostor || '-'}`,
                `<b>Aktuelle Runde:</b> ${data.round}`,
                `<b>Game gestartet:</b> ${data.game_started ? 'Ja' : 'Nein'}`,
                `<b>Voting aktiv:</b> ${data.voting_active ? 'Ja' : 'Nein'}`,
                `<b>Gewinnerwort:</b> ${data.winning_word || '-'}`
            ];
            document.getElementById('stats-list').innerHTML = stats.map(s => `<li>${s}</li>`).join('');
            // Update player list
            updatePlayerList(data.players);
            // Update spicy mode
            updateSpicyMode(data.spicy_mode, data.announce_spicy_mode);
            // Update settings
            document.getElementById('heartbeat-timeout').value = data.settings.heartbeat_timeout;
            document.getElementById('cleanup-interval').value = data.settings.cleanup_interval;

            // --- Blur logic for live stats ---
            const liveStatsCard = document.getElementById('live-stats-card');
            const overlay = document.getElementById('live-stats-overlay');
            // Blur if game is running (not lobby or ended)
            if (data.game_state === 'running' && !liveStatsRevealed) {
                liveStatsCard.classList.add('blurred');
                overlay.style.display = 'flex';
            } else {
                liveStatsCard.classList.remove('blurred');
                overlay.style.display = 'none';
            }
        });
    }
    setInterval(updateStats, 2000);
    updateStats();

    // --- Player List ---
    function updatePlayerList(players) {
        let html = '';
        players.forEach(player => {
            html += `<div class="player-card" data-player="${player}">
                        <span>${player}</span>
                        <span class="kick-cross" title="Kicken" onclick="kickPlayer('${player}')">×</span>
                    </div>`;
        });
        document.getElementById('player-list').innerHTML = html;
    }
    function kickPlayer(player) {
        if(confirm(`Spieler "${player}" wirklich kicken?`)) {
            fetch('/api/kick_player', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({player_name: player})
            }).then(() => updateStats());
        }
    }

    // --- Reset Game ---
    document.getElementById('reset-game-btn').onclick = function() {
        if(confirm('Spiel und alle Spieler zurücksetzen?')) {
            window.location.href = '/control/reset_game';
        }
    };

    // --- Reset Leaderboard ---
    function resetLeaderboard(which) {
        if(confirm('Leaderboard wirklich zurücksetzen?')) {
            fetch('/api/reset_leaderboard', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({which: which})
            }).then(() => alert('Leaderboard zurückgesetzt!'));
        }
    }

    // --- Start Game ---
    document.getElementById('start-game-btn').onclick = function() {
        window.location.href = '/control/start_game';
    };

    // --- Spicy Mode Toggle ---
    function updateSpicyMode(mode, announce) {
        let status = '';
        let statusField = document.getElementById('spicy-mode-status');
        statusField.innerHTML = '';
        document.getElementById('spicy-disabled').classList.remove('active');
        document.getElementById('spicy-possible').classList.remove('active');
        document.getElementById('spicy-forced').classList.remove('active');
        if(mode === 'disabled') {
            document.getElementById('spicy-disabled').classList.add('active');
            status = 'Nur normale Wörter.';
        } else if(mode === 'possible') {
            document.getElementById('spicy-possible').classList.add('active');
            status = 'Normale + Spicy Wörter.';
            statusField.innerHTML = '<span class="spicy-announcement possible">Normal + Spicy Wörter!</span>';
        } else if(mode === 'forced') {
            document.getElementById('spicy-forced').classList.add('active');
            status = 'Nur Spicy Wörter!';
            statusField.innerHTML = '<span class="spicy-announcement forced">Nur Spicy Wörter!</span>';
        }
        if(mode === 'disabled') statusField.textContent = status;
        // Set the checkbox for announce spicy mode
        fetch('/api/settings').then(r => r.json()).then(settings => {
            document.getElementById('announce-spicy-toggle').checked = !!settings.announce_spicy_mode;
        });
    }
    document.getElementById('spicy-disabled').onclick = function() {
        fetch('/api/spicy_mode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: 'disabled'})
        }).then(() => updateStats());
    };
    document.getElementById('spicy-possible').onclick = function() {
        fetch('/api/spicy_mode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: 'possible'})
        }).then(() => updateStats());
    };
    document.getElementById('spicy-forced').onclick = function() {
        fetch('/api/spicy_mode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: 'forced'})
        }).then(() => updateStats());
    };

    // --- Settings ---
    document.getElementById('settings-form').onsubmit = function(e) {
        e.preventDefault();
        let heartbeat = document.getElementById('heartbeat-timeout').value;
        let cleanup = document.getElementById('cleanup-interval').value;
        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({heartbeat_timeout: heartbeat, cleanup_interval: cleanup})
        }).then(() => {
            document.getElementById('settings-status').textContent = 'Gespeichert!';
            setTimeout(() => document.getElementById('settings-status').textContent = '', 2000);
        });
    };

    // --- Copy Game Link ---
    document.getElementById('copy-link-btn').onclick = function() {
        navigator.clipboard.writeText('https://impostergame.xyz');
        this.textContent = '✅ Link kopiert!';
        setTimeout(() => {
            this.textContent = '🔗 Game-Link kopieren';
        }, 1500);
    };

    document.getElementById('announce-spicy-toggle').onchange = function() {
        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({announce_spicy_mode: this.checked})
        });
    };

    document.getElementById('change-password-form').onsubmit = function(e) {
        e.preventDefault();
        const pw = document.getElementById('new-password').value.trim();
        const status = document.getElementById('password-status');
        if (pw.length < 4) {
            status.textContent = '❌ Passwort zu kurz (min. 4 Zeichen)';
            status.style.color = '#e74c3c';
            return;
        }
        fetch('/api/change_password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: pw})
        }).then(r => r.json()).then(data => {
            if (data.success) {
                status.textContent = '✅ Passwort erfolgreich geändert!';
                status.style.color = '#27ae60';
                document.getElementById('new-password').value = '';
            } else {
                status.textContent = '❌ ' + (data.error || 'Fehler beim Ändern');
                status.style.color = '#e74c3c';
            }
        });
    };

    // Overlay click handler
    document.addEventListener('DOMContentLoaded', function() {
        liveStatsRevealed = false;
        const overlay = document.getElementById('live-stats-overlay');
        if (overlay) {
            overlay.addEventListener('click', function() {
                liveStatsRevealed = true;
                document.getElementById('live-stats-card').classList.remove('blurred');
                overlay.style.display = 'none';
            });
        }
        // Collapsible backup list logic
        const toggleBackupListBtn = document.getElementById('toggle-backup-list-btn');
        const collapsibleBackupList = document.getElementById('collapsible-backup-list');
        if (toggleBackupListBtn && collapsibleBackupList) {
            toggleBackupListBtn.onclick = function() {
                collapsibleBackupList.classList.toggle('open');
                toggleBackupListBtn.textContent = collapsibleBackupList.classList.contains('open') ? 'Backups & Downloads ausblenden' : 'Backups & Downloads anzeigen';
            };
        }
        // Backup Leaderboard button
        const backupLeaderboardBtn = document.getElementById('backup-leaderboard-btn');
        if (backupLeaderboardBtn) {
            backupLeaderboardBtn.onclick = function() {
                const status = document.getElementById('leaderboard-backup-status');
                fetch('/api/create_leaderboard_backup', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            status.textContent = '✅ Backup erfolgreich erstellt: ' + data.backup;
                            status.style.color = '#27ae60';
                            updateLeaderboardFileStatus();
                        } else {
                            status.textContent = '❌ ' + (data.error || 'Fehler beim Backup');
                            status.style.color = '#e74c3c';
                        }
                    })
                    .catch(() => {
                        status.textContent = '❌ Fehler beim Backup.';
                        status.style.color = '#e74c3c';
                    });
            };
        }

        // Dark mode toggle logic
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').textContent = '☀️';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('dark-mode-toggle').textContent = '🌙';
            }
            localStorage.setItem('darkMode', enabled ? '1' : '0');
        }
        var darkToggle = document.getElementById('dark-mode-toggle');
        if (darkToggle) {
            darkToggle.onclick = function() {
                setDarkMode(!document.body.classList.contains('dark-mode'));
            };
            // On page load, apply saved preference
            const saved = localStorage.getItem('darkMode');
            if (saved === '1') setDarkMode(true);
            else setDarkMode(false);
        }
    });

    // --- Leaderboard file status ---
    let leaderboardExists = false;
    let backupExists = false;
    let latestBackupFile = null;
    function updateLeaderboardFileStatus() {
        fetch('/api/backup_leaderboard').then(r => {
            leaderboardExists = (r.status === 200);
            document.getElementById('status-leaderboard-json').innerHTML = `<span class='status-icon'>${leaderboardExists ? '✅' : '❌'}</span> Leaderboard: ${leaderboardExists ? 'Vorhanden' : 'Fehlt'}<span class='filename'>leaderboard.json</span>`;
            document.getElementById('status-leaderboard-json').className = 'file-status ' + (leaderboardExists ? 'present' : 'missing');
            document.getElementById('download-leaderboard-btn').disabled = !leaderboardExists;
        });
        fetch('/api/list_leaderboard_backups').then(r => r.json()).then(data => {
            const backupList = document.getElementById('backup-list');
            backupList.innerHTML = '';
            if (data.success && data.backups.length > 0) {
                backupExists = true;
                latestBackupFile = data.backups[0];
                document.getElementById('status-leaderboard-bckp').innerHTML = `<span class='status-icon'>✅</span> Backup: Vorhanden<span class='filename'>${latestBackupFile}</span>`;
                // List all backups
                data.backups.forEach(function(filename) {
                    const li = document.createElement('li');
                    li.className = 'backup-list-item';
                    li.innerHTML = `<span class='backup-filename'>${filename}</span>` +
                        `<button class='backup-action-btn' onclick="window.open('/api/download_leaderboard_backup_file?name=${encodeURIComponent(filename)}','_blank')">Download</button>` +
                        `<button class='backup-action-btn restore' onclick="restoreBackup('${filename}')">Als Leaderboard laden</button>`;
                    backupList.appendChild(li);
                });
            } else {
                backupExists = false;
                latestBackupFile = null;
                document.getElementById('status-leaderboard-bckp').innerHTML = `<span class='status-icon'>❌</span> Backup: Kein Backup vorhanden`;
            }
        });
    }
    updateLeaderboardFileStatus();
    setInterval(updateLeaderboardFileStatus, 10000);

    // Custom file input logic
    const fileInput = document.getElementById('upload-leaderboard-file');
    const fileLabel = document.querySelector('.custom-file-label');
    const fileNameSpan = document.getElementById('selected-leaderboard-filename');
    const uploadActions = document.getElementById('leaderboard-upload-actions');
    fileLabel.onclick = function() { fileInput.click(); };
    fileInput.onchange = function() {
        if (fileInput.files.length) {
            fileNameSpan.textContent = fileInput.files[0].name;
            document.getElementById('upload-leaderboard-btn').disabled = false;
        } else {
            fileNameSpan.textContent = 'Keine Datei gewählt';
            document.getElementById('upload-leaderboard-btn').disabled = true;
        }
    };
    document.getElementById('upload-leaderboard-btn').disabled = true;
    document.getElementById('download-leaderboard-btn').onclick = function() {
        if (leaderboardExists) window.open('/api/backup_leaderboard', '_blank');
    };
    document.getElementById('upload-leaderboard-btn').onclick = function() {
        uploadLeaderboardFile('/api/upload_leaderboard');
    };
    document.getElementById('load-backup-btn').onclick = function() {
        if (!backupExists || !latestBackupFile) return;
        const status = document.getElementById('leaderboard-backup-status');
        fetch('/api/upload_leaderboard', {
            method: 'POST',
            body: (() => {
                const formData = new FormData();
                return fetch('/api/download_leaderboard_backup_file?name=' + encodeURIComponent(latestBackupFile))
                    .then(r => r.blob())
                    .then(blob => { formData.append('file', blob, latestBackupFile); return formData; });
            })()
        }).then(async r => r.json()).then(data => {
            if (data.success) {
                status.textContent = '✅ Backup erfolgreich als Leaderboard geladen!';
                status.style.color = '#27ae60';
                updateLeaderboardFileStatus();
            } else {
                status.textContent = '❌ ' + (data.error || 'Fehler beim Laden des Backups');
                status.style.color = '#e74c3c';
            }
        }).catch(() => {
            status.textContent = '❌ Fehler beim Laden des Backups.';
            status.style.color = '#e74c3c';
        });
    };
    function uploadLeaderboardFile(endpoint) {
        const status = document.getElementById('leaderboard-backup-status');
        if (!fileInput.files.length) {
            status.textContent = '❌ Bitte wähle eine Datei aus.';
            status.style.color = '#e74c3c';
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        fetch(endpoint, {
            method: 'POST',
            body: formData
        }).then(r => r.json()).then(data => {
            if (data.success) {
                status.textContent = '✅ Datei erfolgreich hochgeladen!';
                status.style.color = '#27ae60';
                fileInput.value = '';
                fileNameSpan.textContent = 'Keine Datei gewählt';
                document.getElementById('upload-leaderboard-btn').disabled = true;
                updateLeaderboardFileStatus();
            } else {
                status.textContent = '❌ ' + (data.error || 'Fehler beim Hochladen');
                status.style.color = '#e74c3c';
            }
        }).catch(() => {
            status.textContent = '❌ Fehler beim Hochladen.';
            status.style.color = '#e74c3c';
        });
    }
    function restoreBackup(filename) {
        const status = document.getElementById('leaderboard-backup-status');
        fetch('/api/download_leaderboard_backup_file?name=' + encodeURIComponent(filename))
            .then(r => r.blob())
            .then(blob => {
                const formData = new FormData();
                formData.append('file', blob, filename);
                return fetch('/api/upload_leaderboard', {
                    method: 'POST',
                    body: formData
                });
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    status.textContent = '✅ Backup erfolgreich als Leaderboard geladen!';
                    status.style.color = '#27ae60';
                    updateLeaderboardFileStatus();
                } else {
                    status.textContent = '❌ ' + (data.error || 'Fehler beim Laden des Backups');
                    status.style.color = '#e74c3c';
                }
            })
            .catch(() => {
                status.textContent = '❌ Fehler beim Laden des Backups.';
                status.style.color = '#e74c3c';
            });
    }
    document.getElementById('backup-leaderboard-btn').onclick = function() {
        const status = document.getElementById('leaderboard-backup-status');
        fetch('/api/create_leaderboard_backup', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    status.textContent = '✅ Backup erfolgreich erstellt: ' + data.backup;
                    status.style.color = '#27ae60';
                    updateLeaderboardFileStatus();
                } else {
                    status.textContent = '❌ ' + (data.error || 'Fehler beim Backup');
                    status.style.color = '#e74c3c';
                }
            })
            .catch(() => {
                status.textContent = '❌ Fehler beim Backup.';
                status.style.color = '#e74c3c';
            });
    };

    // Collapsible backup list logic
    const toggleBackupListBtn = document.getElementById('toggle-backup-list-btn');
    const collapsibleBackupList = document.getElementById('collapsible-backup-list');
    toggleBackupListBtn.onclick = function() {
        collapsibleBackupList.classList.toggle('open');
        toggleBackupListBtn.textContent = collapsibleBackupList.classList.contains('open') ? 'Backups & Downloads ausblenden' : 'Backups & Downloads anzeigen';
    };
    </script>
</body>
</html>
